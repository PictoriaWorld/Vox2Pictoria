name: Release

on:
  push:
    branches: [main]

env:
  BLENDER_VERSION: "4.5.6"

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      notes: ${{ steps.notes.outputs.notes }}
      skip: ${{ steps.check-tag.outputs.exists }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from CHANGELOG.md
        id: version
        run: |
          version=$(grep -m1 -oP '## \[\K[0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md)
          if [ -z "$version" ]; then
            echo "No version heading found in CHANGELOG.md"
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Detected version: $version"

      - name: Extract release notes
        id: notes
        run: |
          # Extract everything between the first and second ## [ headings
          notes=$(awk '/^## \[/{if(found) exit; found=1; next} found' CHANGELOG.md)
          {
            echo "notes<<NOTES_EOF"
            echo "$notes"
            echo "NOTES_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Check if tag already exists
        id: check-tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "Tag v${{ steps.version.outputs.version }} already exists â€” skipping release."
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    strategy:
      matrix:
        include:
          - rid: win-x64
            runner: windows-latest
            blender_arch: windows-x64
            blender_ext: .zip
          - rid: linux-x64
            runner: ubuntu-latest
            blender_arch: linux-x64
            blender_ext: .tar.xz
          - rid: osx-arm64
            runner: macos-14
            blender_arch: macos-arm64
            blender_ext: .dmg
    runs-on: ${{ matrix.runner }}
    env:
      VERSION: ${{ needs.check-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Publish
        run: >
          dotnet publish Vox2Pictoria/Vox2Pictoria.csproj
          -c Release
          -r ${{ matrix.rid }}
          --self-contained true
          -p:PublishSingleFile=true
          -o publish

      - name: Download Blender
        shell: bash
        run: |
          BLENDER_MAJOR_MINOR=$(echo "$BLENDER_VERSION" | cut -d. -f1-2)
          BLENDER_FILE="blender-${BLENDER_VERSION}-${{ matrix.blender_arch }}${{ matrix.blender_ext }}"
          curl -fSL -o "$BLENDER_FILE" \
            "https://download.blender.org/release/Blender${BLENDER_MAJOR_MINOR}/${BLENDER_FILE}"
          echo "BLENDER_FILE=$BLENDER_FILE" >> "$GITHUB_ENV"
          echo "BLENDER_MAJOR_MINOR=$BLENDER_MAJOR_MINOR" >> "$GITHUB_ENV"

      - name: Extract Blender (Windows)
        if: matrix.rid == 'win-x64'
        shell: pwsh
        run: |
          Expand-Archive -Path $env:BLENDER_FILE -DestinationPath blender-temp
          $inner = Get-ChildItem -Directory blender-temp | Select-Object -First 1
          Move-Item $inner.FullName publish/blender

      - name: Extract Blender (Linux)
        if: matrix.rid == 'linux-x64'
        run: |
          tar -xf "$BLENDER_FILE"
          inner=$(ls -d blender-*/ | head -1)
          mv "$inner" publish/blender

      - name: Extract Blender (macOS)
        if: matrix.rid == 'osx-arm64'
        run: |
          hdiutil attach "$BLENDER_FILE" -nobrowse -quiet
          MOUNT=$(ls /Volumes/ | grep -i blender | head -1)
          mkdir -p publish/blender
          cp -R "/Volumes/$MOUNT/Blender.app/Contents/MacOS/"* publish/blender/
          cp -R "/Volumes/$MOUNT/Blender.app/Contents/Resources/$BLENDER_MAJOR_MINOR" publish/blender/
          cp -R "/Volumes/$MOUNT/Blender.app/Contents/Resources/lib" publish/blender/
          # Ensure a lowercase 'blender' binary exists (GetBlenderPath() expects it)
          if [ ! -f publish/blender/blender ]; then
            ln -s Blender publish/blender/blender
          fi
          hdiutil detach "/Volumes/$MOUNT" -quiet || true

      - name: Copy GPL license
        shell: bash
        run: cp thirdPartyLicenses/BLENDER_LICENSE.txt publish/

      - name: Fix permissions
        if: matrix.rid != 'win-x64'
        run: |
          chmod +x publish/Vox2Pictoria
          chmod +x publish/blender/blender || chmod +x publish/blender/Blender || true

      - name: Bundle sample scene
        shell: bash
        run: cp Vox2Pictoria/assets/garden.vox publish/garden.vox

      - name: Package (Windows)
        if: matrix.rid == 'win-x64'
        shell: pwsh
        run: |
          Compress-Archive -Path publish\* -DestinationPath "Vox2Pictoria-v${env:VERSION}-${{ matrix.rid }}.zip"

      - name: Package (Linux/macOS)
        if: matrix.rid != 'win-x64'
        run: |
          cd publish
          zip -r -y "../Vox2Pictoria-v${VERSION}-${{ matrix.rid }}.zip" .
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.rid }}
          path: Vox2Pictoria-v${{ env.VERSION }}-${{ matrix.rid }}.zip

  create-github-release:
    needs: [check-version, build]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.check-version.outputs.version }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release and upload assets
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes "${{ needs.check-version.outputs.notes }}" \
            artifacts/*/*.zip
